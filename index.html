<html>
    <head>
        <meta name="description" content="Koncerto is a simple PHP framework. The main concept is to have a light PHP framework in a single PHP script. Koncerto uses TinyButStrong for its template engine. https://github.com/koncerto-framework">
        <meta name="google-site-verification" content="QU1F7uhFGM5se6kjAHMdumz-5qhnifAqHdgAQdewGRk" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
        <script async type="module" src="https://cdn.jsdelivr.net/npm/php-wasm@0.0.9-alpha-20/php-tags.mjs"></script>
        <script type="text/javascript">

            function proxyPhp(url, callback) {
                var result = document.createElement('section');
                var id = new Date().getTime();
                result.setAttribute('id', 'result-' + id);
                result.setAttribute('style', 'display: none;');
                document.body.appendChild(result);
                var script = php('#result-' + id, url);
                script.setAttribute('id', 'php-' + id)
                document.body.appendChild(script);
                setTimeout(function() {
                    var html = result.innerHTML;
                    result.parentNode.removeChild(result);
                    script.parentNode.removeChild(script);
                    callback(html);
                }, 500);
            }

            function proxy(url) {
                return `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`;
            }

            function php(target) {
                if ('undefined' !== typeof newUrl) {
                    if (0 !== newUrl.indexOf('http')) {
                        var tmpUrl = new URL(new String(location));
                        tmpUrl.hash = newUrl;
                        newUrl = new String(tmpUrl);
                    }
                }
                var useHash = true;
                var url = new URL(new String('undefined' !== typeof newUrl ? newUrl : location));
                var useHash = true;
                var pathInfo = new String(url.pathname);
                var queryString = new String(url.search);
                if (useHash) {
                    pathInfo = new String(url.hash).substring(1);
                    if (-1 !== pathInfo.indexOf('?')) {
                        queryString = pathInfo.substring(pathInfo.indexOf('?') + 1);
                        pathInfo = pathInfo.substring(0, pathInfo.indexOf('?'));
                    }
                }
                if ('' === pathInfo) {
                    pathInfo = '/';
                }

                var files = [
                    {
                        name: 'koncerto.php',
                        parent: '/preload/',
                        url : 'https://cdn.jsdelivr.net/gh/koncerto-framework/koncerto-playground/koncerto.php'
                    },
                    {
                        name: 'tbs_class.php',
                        parent: '/preload/',
                        url : 'https://cdn.jsdelivr.net/gh/Skrol29/tinybutstrong@latest/tbs_class.php'
                    },
                    {
                        name: 'Introduction.md',
                        parent: '/preload/',
                        url: proxy('https://raw.githubusercontent.com/wiki/koncerto-framework/koncerto-framework/Introduction.md')
                    },
                    {
                        name: 'KoncertoController.md',
                        parent: '/preload/',
                        url: proxy('https://raw.githubusercontent.com/wiki/koncerto-framework/koncerto-framework/KoncertoController.md')
                    },
                    {
                        name: 'KoncertoLive.md',
                        parent: '/preload/',
                        url: proxy('https://raw.githubusercontent.com/wiki/koncerto-framework/koncerto-framework/KoncertoLive.md')
                    },
                    {
                        name: 'KoncertoForm.md',
                        parent: '/preload/',
                        url: proxy('https://raw.githubusercontent.com/wiki/koncerto-framework/koncerto-framework/KoncertoForm.md')
                    }
                ];
                var script = document.createElement('script');
                script.setAttribute('type', 'text/php');
                script.setAttribute('data-files', JSON.stringify(files));
                script.setAttribute('data-stdout', target);
                script.innerText = `<?php

                    $storage = array(
                        '_cache' => array(),
                        '_controller' => array(
                            'HomeController.php',
                            'DocumentationController.php'
                        ),
                        '_templates' => array(
                            '_layout.tbs.html',
                            'index.tbs.html',
                            'doc.tbs.html'
                        )
                    );

                    foreach ($storage as $dir => $files) {
                        if (!is_dir($dir)) {
                            mkdir($dir);
                        }
                        foreach ($files as $file) {
                            file_put_contents(
                                sprintf('%s/%s', $dir, $file),
                                file_get_contents(sprintf(
                                    'https://cdn.jsdelivr.net/gh/koncerto-framework/koncerto-framework.github.io/%s/%s',
                                    $dir,
                                    $file
                                ))
                            );
                        }
                    }

                    require_once('/preload/koncerto.php');

                    Koncerto::setConfig(array(
                        'routing' => array('useHash' => '${useHash}'),
                        'documentRoot' => '/preload/',
                        'request' => array(
                            'pathInfo' => '${pathInfo}',
                            'queryString' => '${queryString}'
                        )
                    ));

                    echo Koncerto::response();
                `;

                return script;
            }

            var script = php(':root');

            window.reloadScript = function(selector) {
                document.querySelector(selector);
                eval(selector.text);
            }

            var targetNode = document.querySelector(':root');
            var config = { childList: true, subtree: true };
            var callback = function(mutationList, observer) {
                Array.from(mutationList).forEach(function(mutation) {
                    var scripts = mutation.target.querySelectorAll('script');
                    scripts.forEach(function (script) {
                        if ('' !== script.src && script.hasAttribute('data-reload')) {
                            fetch(script.src).then(function (result) {
                                result.text().then(function (js) {
                                    eval(js);
                                    if (script.hasAttribute('onload')) {
                                        eval(script.getAttribute('onload'));
                                    }
                                })
                            });
                        }
                        if ('' === script.src) {
                            if (-1 !== script.text.indexOf('//' + ' require is provided by loader.min.js.')) {
                                setTimeout(function() {
                                    observer.disconnect();
                                    eval(script.text);
                                }, 1000);
                            } else {
                                if (script.hasAttribute('data-reload')) {
                                    observer.disconnect();
                                    eval(script.text);
                                }
                            }
                        }
                    });
                });
            };

            var observer = new MutationObserver(callback);
            observer.observe(targetNode, config);

            var head = document.getElementsByTagName('head')[0];
            head.appendChild(script);
        </script>
    </head>
    <body>
        <div class="container is-fluid" style="height: 100vh;">
            <div class="columns is-mobile is-vcentered" style="height: 100%;">
                <div class="column"></div>
                <div class="column is-narrow"><span class="loader" style="width: 100px; height: 100px;"></span></div>
                <div class="column"></div>
            </div>
        </div>
        <div class="is-hidden">
            <section class="section">
                <h1 class="title">Koncerto</h1>
                <p class="subtitle">Welcome</p>
                <p>Koncerto is a simple PHP framework.</p>
                <p>The main concept is to have a light PHP framework in a single PHP script.</p>
                <p>Koncerto uses TinyButStrong for its template engine.</p>
                <p><a href="/#/doc" onclick="setTimeout(function() { history.go(0); }, 500);">Documentation</a></p>
            </section>
        </div>
    </body>
</html>
